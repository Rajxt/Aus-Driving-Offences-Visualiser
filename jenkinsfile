pipeline {
    agent any
    
    stages {
        stage('Clone Repository') {
            steps {
                echo 'Cloning app from GitHub...'
                checkout scm
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'Building Docker image for Vue.js app...'
                script {
                    sh 'docker build -t aus-vis-app:latest .'
                }
            }
        }
        
        stage('Stop Old Container') {
            steps {
                echo 'Stopping old container...'
                script {
                    sh 'docker stop aus-vis-app || true'
                    sh 'docker rm aus-vis-app || true'
                }
            }
        }
        
        stage('Run New Container') {
            steps {
                echo 'Running new container...'
                script {
                    // Run on port 80 (or 8080 if you prefer)
                    sh 'docker run -d --name aus-vis-app -p 80:80 aus-vis-app:latest'
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo 'Checking if container is running...'
                sh 'docker ps | grep aus-vis-app'
                sh 'sleep 5'
                sh 'curl -f http://localhost:80 || exit 1'
            }
        }
    }
    
    post {
        success {
            echo '✅ Vis app deployed successfully!'
        }
        failure {
            echo '❌ Deployment failed!'
            sh 'docker logs aus-vis-app || true'
        }
    }
}